name: Generate Android Keystore

on:
  workflow_dispatch:
    inputs:
      regenerate:
        description: 'Generate new keystore (type "yes" to confirm)'
        required: true
        default: 'no'

jobs:
  generate-keystore:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Verify regeneration intent
      run: |
        if [ "${{ github.event.inputs.regenerate }}" != "yes" ]; then
          echo "❌ You must type 'yes' to confirm keystore generation"
          echo "⚠️  This will generate a new keystore - only do this if you haven't released your app yet!"
          exit 1
        fi
      
    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Generate random passwords
      id: passwords
      run: |
        # Generate secure random passwords
        KEYSTORE_PASSWORD=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-25)
        KEY_PASSWORD=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-25)
        KEY_ALIAS="recitativos-release"
        
        # Store in GitHub outputs (these are masked in logs)
        echo "keystore_password=$KEYSTORE_PASSWORD" >> $GITHUB_OUTPUT
        echo "key_password=$KEY_PASSWORD" >> $GITHUB_OUTPUT
        echo "key_alias=$KEY_ALIAS" >> $GITHUB_OUTPUT
        
    - name: Generate keystore
      run: |
        # Create android directory
        mkdir -p android
        
        # Generate keystore
        keytool -genkeypair -v -keystore android/recitativos-release.keystore \
          -alias "${{ steps.passwords.outputs.key_alias }}" \
          -keyalg RSA \
          -keysize 2048 \
          -validity 25000 \
          -storepass "${{ steps.passwords.outputs.keystore_password }}" \
          -keypass "${{ steps.passwords.outputs.key_password }}" \
          -dname "CN=Recitativos CCB, OU=Mobile Development, O=Vineyard Technologies, L=Unknown, ST=Unknown, C=US"
        
        echo "✅ Keystore created successfully!"
        
    - name: Create secrets file
      run: |
        # Convert keystore to base64
        base64_keystore=$(base64 -w 0 android/recitativos-release.keystore)
        
        # Create secrets file (this will be downloaded privately)
        cat > github-secrets.txt << 'EOF'
GitHub Secrets for Recitativos CCB Android Build
===============================================

Add these secrets to your GitHub repository:
(Settings > Secrets and variables > Actions)

ANDROID_KEYSTORE_BASE64:
EOF
        echo "$base64_keystore" >> github-secrets.txt
        cat >> github-secrets.txt << 'EOF'

KEYSTORE_PASSWORD:
EOF
        echo "${{ steps.passwords.outputs.keystore_password }}" >> github-secrets.txt
        cat >> github-secrets.txt << 'EOF'

KEY_PASSWORD:
EOF
        echo "${{ steps.passwords.outputs.key_password }}" >> github-secrets.txt
        cat >> github-secrets.txt << 'EOF'

KEY_ALIAS:
EOF
        echo "${{ steps.passwords.outputs.key_alias }}" >> github-secrets.txt
        cat >> github-secrets.txt << 'EOF'

⚠️  IMPORTANT: 
- Keep this file secure and delete it after adding secrets to GitHub
- Never commit this file to git
- Store the keystore file safely as backup
- These secrets are NOT visible in the GitHub Actions logs

📋 Setup Instructions:
1. Download both artifacts from this workflow run
2. Add the 4 secrets above to your GitHub repository
3. Keep the keystore file as backup
4. Delete this secrets file after setup
EOF
        
        echo "🔐 Secrets file created (will be available as private download)"
        
    - name: Upload keystore artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-keystore
        path: android/recitativos-release.keystore
        retention-days: 30
        
    - name: Upload secrets file artifact
      uses: actions/upload-artifact@v4
      with:
        name: github-secrets
        path: github-secrets.txt
        retention-days: 7
        
    - name: Summary
      run: |
        echo "✅ Keystore generation completed successfully!"
        echo ""
        echo "📥 Next steps:"
        echo "1. Download the 'github-secrets' artifact from this workflow run"
        echo "2. Open the downloaded file to get your 4 GitHub secrets"
        echo "3. Add those secrets to your repository (Settings > Secrets and variables > Actions)"
        echo "4. Download the 'android-keystore' artifact as backup"
        echo "5. Delete the secrets file after adding to GitHub"
        echo ""
        echo "🔒 Security: The actual secrets are NOT visible in these logs!"
        echo "🔒 Only you can download the artifacts from this workflow run"
